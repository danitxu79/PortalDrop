name: Build All Platforms

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # --- TRABAJO 1: LINUX (Debian, RPM, Arch) ---
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libegl1 libdbus-1-3 xkb-data libxcb-cursor0 libxkbcommon-x11-0 ruby ruby-dev build-essential libarchive-tools
        sudo gem install fpm

    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Linux Binary
      run: |
        # Usamos el separador : para Linux en add-data
        pyinstaller --noconfirm --onefile --windowed --name "portaldrop" --add-data "portaldrop-512.png:." --icon "portaldrop-512.png" PortalDrop.py

    - name: Create Linux Packages (DEB/RPM/PACMAN)
      run: |
        mkdir -p dist_package/usr/bin
        mkdir -p dist_package/usr/share/icons/hicolor/512x512/apps
        mkdir -p dist_package/usr/share/applications

        cp dist/portaldrop dist_package/usr/bin/portaldrop
        chmod +x dist_package/usr/bin/portaldrop
        cp portaldrop-512.png dist_package/usr/share/icons/hicolor/512x512/apps/portaldrop.png

        echo "[Desktop Entry]
        Name=PortalDrop
        Comment=AirDrop para Linux
        Exec=/usr/bin/portaldrop
        Icon=portaldrop
        Type=Application
        Categories=Utility;Network;
        Terminal=false" > dist_package/usr/share/applications/portaldrop.desktop

        # DEB
        fpm -s dir -t deb -n portaldrop -v 1.0.0 -C dist_package --description "AirDrop local" --maintainer "TuNombre" --architecture native -p portaldrop_linux_amd64.deb
        # RPM
        fpm -s dir -t rpm -n portaldrop -v 1.0.0 -C dist_package --description "AirDrop local" --architecture x86_64 -p portaldrop_linux_x86_64.rpm
        # PACMAN
        fpm -s dir -t pacman -n portaldrop -v 1.0.0 -C dist_package --description "AirDrop local" --architecture x86_64 -p portaldrop_linux_x86_64.pkg.tar.zst

    - name: Upload Linux Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PortalDrop-Linux
        path: |
          portaldrop_linux_amd64.deb
          portaldrop_linux_x86_64.rpm
          portaldrop_linux_x86_64.pkg.tar.zst
          dist/portaldrop

  # --- TRABAJO 2: WINDOWS (.exe) ---
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Convert Icon to ICO
      # Windows necesita .ico. Usamos Pillow (ya instalado) para convertirlo al vuelo.
      run: |
        python -c "from PIL import Image; Image.open('portaldrop-512.png').save('icon.ico', format='ICO', sizes=[(256, 256)])"

    - name: Build Windows Exe
      run: |
        # En Windows el separador de add-data es ;
        pyinstaller --noconfirm --onefile --windowed --name "PortalDrop" --add-data "portaldrop-512.png;." --icon "icon.ico" PortalDrop.py

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PortalDrop-Windows
        path: dist/PortalDrop.exe

  # --- TRABAJO 3: MACOS (.app) ---
  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build macOS App
      run: |
        # En Mac el separador es :
        # Generar√° dist/PortalDrop.app
        pyinstaller --noconfirm --windowed --name "PortalDrop" --add-data "portaldrop-512.png:." --icon "portaldrop-512.png" PortalDrop.py

    - name: Zip Application
      # GitHub no deja subir carpetas .app tal cual, hay que comprimirlas
      run: |
        cd dist
        zip -r PortalDrop-macOS.zip PortalDrop.app

    - name: Upload macOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PortalDrop-MacOS
        path: dist/PortalDrop-macOS.zip
