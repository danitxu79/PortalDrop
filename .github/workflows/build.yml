name: Build and Release

# SE ACTIVA CUANDO:
# 1. Creas una Release (publicada)
# 2. Haces push a main (para comprobar que no rompes nada, aunque no subirÃ¡ archivos a releases)
on:
  release:
    types: [published]
  push:
    branches: [ "main" ]
  workflow_dispatch:

# PERMISOS NECESARIOS PARA SUBIR ARCHIVOS
permissions:
  contents: write

jobs:
  # --- LINUX ---
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        # Incluimos el arreglo para Manjaro (libarchive-tools)
        sudo apt-get install -y libegl1 libdbus-1-3 xkb-data libxcb-cursor0 libxkbcommon-x11-0 ruby ruby-dev build-essential libarchive-tools
        sudo gem install fpm

    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Linux Binary
      run: |
        pyinstaller --noconfirm --onefile --windowed --name "portaldrop" --add-data "portaldrop-512.png:." --icon "portaldrop-512.png" PortalDrop.py

    - name: Create Linux Packages
      run: |
        mkdir -p dist_package/usr/bin
        mkdir -p dist_package/usr/share/icons/hicolor/512x512/apps
        mkdir -p dist_package/usr/share/applications

        cp dist/portaldrop dist_package/usr/bin/portaldrop
        chmod +x dist_package/usr/bin/portaldrop
        cp portaldrop-512.png dist_package/usr/share/icons/hicolor/512x512/apps/portaldrop.png

        echo "[Desktop Entry]
        Name=PortalDrop
        Comment=AirDrop para Linux
        Exec=/usr/bin/portaldrop
        Icon=portaldrop
        Type=Application
        Categories=Utility;Network;
        Terminal=false" > dist_package/usr/share/applications/portaldrop.desktop

        # DEB, RPM, PACMAN
        fpm -s dir -t deb -n portaldrop -v ${{ github.event.release.tag_name || '1.0.0' }} -C dist_package --description "AirDrop local" --maintainer "TuNombre" --architecture native -p portaldrop_linux_amd64.deb
        fpm -s dir -t rpm -n portaldrop -v ${{ github.event.release.tag_name || '1.0.0' }} -C dist_package --description "AirDrop local" --architecture x86_64 -p portaldrop_linux_x86_64.rpm
        fpm -s dir -t pacman -n portaldrop -v ${{ github.event.release.tag_name || '1.0.0' }} -C dist_package --description "AirDrop local" --architecture x86_64 -p portaldrop_linux_x86_64.pkg.tar.zst

    # ESTE ES EL PASO NUEVO: Subir a la Release
    - name: Upload to Release
      if: github.event_name == 'release' # Solo si es una release real
      uses: softprops/action-gh-release@v1
      with:
        files: |
          portaldrop_linux_amd64.deb
          portaldrop_linux_x86_64.rpm
          portaldrop_linux_x86_64.pkg.tar.zst
          dist/portaldrop

  # --- WINDOWS ---
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Convert Icon and Build
      run: |
        python -c "from PIL import Image; Image.open('portaldrop-512.png').save('icon.ico', format='ICO', sizes=[(256, 256)])"
        pyinstaller --noconfirm --onefile --windowed --name "PortalDrop" --add-data "portaldrop-512.png;." --icon "icon.ico" PortalDrop.py

    - name: Upload to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/PortalDrop.exe

  # --- MACOS ---
  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build and Zip
      run: |
        pyinstaller --noconfirm --windowed --name "PortalDrop" --add-data "portaldrop-512.png:." --icon "portaldrop-512.png" PortalDrop.py
        cd dist
        zip -r PortalDrop-macOS.zip PortalDrop.app

    - name: Upload to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/PortalDrop-macOS.zip
