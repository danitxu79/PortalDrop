name: Build Linux Packages

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: # Permite ejecutarlo manualmente desde la pestaña Actions

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Bajar el código
    - uses: actions/checkout@v3

    # 2. Instalar Python
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    # 3. Instalar dependencias del sistema (necesarias para compilar Qt)
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libegl1 libdbus-1-3 xkb-data libxcb-cursor0 libxkbcommon-x11-0 ruby ruby-dev build-essential
        # Instalar FPM (herramienta para crear paquetes deb/rpm)
        sudo gem install fpm

    # 4. Instalar librerías Python
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    # 5. Crear el Binario (PyInstaller)
    # --onefile: Todo en un solo archivo
    # --windowed: No abrir consola negra
    # --add-data: Metemos el PNG dentro del ejecutable
    - name: Build Binary with PyInstaller
      run: |
        pyinstaller --noconfirm --onefile --windowed --name "portaldrop" --add-data "portaldrop-512.png:." --icon "portaldrop-512.png" PortalDrop.py

    # 6. Preparar estructura de carpetas para el empaquetado
    - name: Prepare Package Structure
      run: |
        mkdir -p dist_package/usr/bin
        mkdir -p dist_package/usr/share/icons/hicolor/512x512/apps
        mkdir -p dist_package/usr/share/applications

        # Copiar el binario compilado
        cp dist/portaldrop dist_package/usr/bin/portaldrop
        chmod +x dist_package/usr/bin/portaldrop

        # Copiar icono
        cp portaldrop-512.png dist_package/usr/share/icons/hicolor/512x512/apps/portaldrop.png

        # Crear archivo .desktop (Para que salga en el menú de inicio)
        echo "[Desktop Entry]
        Name=PortalDrop
        Comment=AirDrop para Linux
        Exec=/usr/bin/portaldrop
        Icon=portaldrop
        Type=Application
        Categories=Utility;Network;
        Terminal=false" > dist_package/usr/share/applications/portaldrop.desktop

    # 7. Crear Paquete .DEB (Debian, Ubuntu, Mint, Kali)
    - name: Build .DEB
      run: |
        fpm -s dir -t deb -n portaldrop -v 1.0.0 \
        -C dist_package \
        --description "AirDrop local para Linux" \
        --maintainer "TuNombre" \
        --url "https://github.com/${{ github.repository }}" \
        --architecture native \
        -p portaldrop_linux_amd64.deb

    # 8. Crear Paquete .RPM (Fedora, RedHat, CentOS, OpenSUSE)
    - name: Build .RPM
      run: |
        fpm -s dir -t rpm -n portaldrop -v 1.0.0 \
        -C dist_package \
        --description "AirDrop local para Linux" \
        --architecture x86_64 \
        -p portaldrop_linux_x86_64.rpm

    # 9. Crear Paquete .PACMAN (Arch Linux, Manjaro)
    - name: Build .PACMAN
      run: |
        fpm -s dir -t pacman -n portaldrop -v 1.0.0 \
        -C dist_package \
        --description "AirDrop local para Linux" \
        --architecture x86_64 \
        -p portaldrop_linux_x86_64.pkg.tar.zst

    # 10. Subir los archivos generados a GitHub Actions
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Linux-Packages
        path: |
          portaldrop_linux_amd64.deb
          portaldrop_linux_x86_64.rpm
          portaldrop_linux_x86_64.pkg.tar.zst
          dist/portaldrop
